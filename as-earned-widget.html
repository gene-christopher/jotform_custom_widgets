<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>As Earned Agent Lookup - HTML Widget</title>
    <style>
        .agent-lookup-container {
            max-width: 400px;
            margin: 20px auto;
            padding: 20px;
            border: 2px solid #007cba;
            border-radius: 8px;
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        
        .agent-lookup-container h3 {
            color: #007cba;
            margin-top: 0;
            text-align: center;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .lookup-button {
            width: 100%;
            padding: 12px;
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .lookup-button:hover {
            background-color: #005a8b;
        }
        
        .lookup-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .agent-info {
            display: none;
            padding: 15px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .agent-info.show {
            display: block;
        }
        
        .agent-name {
            font-size: 18px;
            font-weight: bold;
            color: #155724;
            margin-bottom: 5px;
        }
        
        .agent-code {
            color: #6c757d;
            font-size: 14px;
        }
        
        .error-message {
            display: none;
            padding: 15px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            color: #721c24;
            margin-bottom: 15px;
        }
        
        .error-message.show {
            display: block;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #007cba;
            font-style: italic;
        }
        
        .loading.show {
            display: block;
        }
        
        .debug-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="agent-lookup-container">
        <h3>Agent Lookup</h3>
        
        <div class="input-group">
            <label for="agentCodeInput">Enter Agent Code:</label>
            <input type="text" id="agentCodeInput" placeholder="Enter agent code here">
        </div>
        
        <button class="lookup-button" id="lookupButton" onclick="lookupAgent()">
            Look Up Agent
        </button>
        
        <button class="lookup-button" id="testButton" onclick="testMode()" style="background-color: #28a745; margin-top: 10px;">
            Test Mode (12345)
        </button>
        
        <div class="loading" id="loading">
            Looking up agent...
        </div>
        
        <div class="agent-info" id="agentInfo">
            <div class="agent-name" id="agentName">Agent Name</div>
            <div class="agent-code" id="agentCodeDisplay">Agent Code</div>
        </div>
        
        <div class="error-message" id="errorMessage">
            Agent not found. Please check the agent code and try again.
        </div>
        
        <div class="debug-info" id="debugInfo">
            <strong>HTML Widget - Direct Form Access</strong><br>
            This widget runs in the form context and can directly access form fields.<br>
            <br>
            <strong>Target Fields:</strong><br>
            • q10_agent_name<br>
            • agent_name_hidden<br>
            • agent_name<br>
            <br>
            <strong>Status:</strong> Ready to lookup agent
        </div>
    </div>

    <script>
        // HTML Widget - Direct Form Access
        console.log('As Earned HTML Widget: Initialized');
        
        function lookupAgent() {
            const agentCode = document.getElementById('agentCodeInput').value.trim();
            
            if (!agentCode) {
                showError('Please enter an agent code');
                return;
            }
            
            console.log('As Earned HTML Widget: Looking up agent code:', agentCode);
            
            // Show loading state
            showLoading(true);
            hideError();
            hideAgentInfo();
            
            // Make API call with CORS handling
            const apiUrl = 'https://api.asearned.com/agents/' + encodeURIComponent(agentCode);
            console.log('As Earned HTML Widget: Making API call to:', apiUrl);
            
            fetch(apiUrl, {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    console.log('As Earned HTML Widget: API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('As Earned HTML Widget: API response data:', data);
                    
                    if (data && data.data && data.data.name) {
                        const agentName = data.data.name;
                        console.log('As Earned HTML Widget: Found agent:', agentName);
                        
                        // Display agent info in widget
                        displayAgentInfo(agentName, agentCode);
                        
                        // Populate form fields directly
                        populateFormFields(agentName, agentCode);
                        
                        // Update debug info
                        updateDebugInfo(agentName, agentCode, true);
                        
                    } else {
                        console.log('As Earned HTML Widget: No agent found');
                        showError('Agent not found');
                        updateDebugInfo('', agentCode, false);
                    }
                })
                .catch(error => {
                    console.error('As Earned HTML Widget: API error:', error);
                    
                    // If API fails for any reason, try test mode
                    console.log('As Earned HTML Widget: API failed, trying test mode');
                    tryAlternativeLookup(agentCode);
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        function displayAgentInfo(agentName, agentCode) {
            document.getElementById('agentName').textContent = agentName;
            document.getElementById('agentCodeDisplay').textContent = 'Code: ' + agentCode;
            document.getElementById('agentInfo').classList.add('show');
        }
        
        function populateFormFields(agentName, agentCode) {
            console.log('As Earned HTML Widget: Populating form fields with:', agentName);
            
            // First, let's see what fields are available on the page
            console.log('As Earned HTML Widget: Searching for all input fields on the page...');
            const allInputs = document.querySelectorAll('input');
            console.log('As Earned HTML Widget: Found', allInputs.length, 'input fields total');
            
            allInputs.forEach((input, index) => {
                console.log(`As Earned HTML Widget: Input ${index}:`, {
                    name: input.name,
                    id: input.id,
                    type: input.type,
                    value: input.value
                });
            });
            
            // List of possible field names to try
            const fieldNames = [
                'q10_agent_name',
                'agent_name_hidden', 
                'agent_name',
                'agentname',
                'foundAgentName',
                'widget_agent_name'
            ];
            
            let fieldsUpdated = 0;
            
            // Try to find and populate each field
            fieldNames.forEach(fieldName => {
                console.log('As Earned HTML Widget: Looking for field:', fieldName);
                
                // Try by name attribute
                let field = document.querySelector(`input[name="${fieldName}"]`);
                if (!field) {
                    // Try by ID
                    field = document.getElementById(fieldName);
                }
                if (!field) {
                    // Try by name containing the field name
                    field = document.querySelector(`input[name*="${fieldName}"]`);
                }
                
                if (field) {
                    field.value = agentName;
                    // Trigger change event
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    console.log('As Earned HTML Widget: Updated field:', fieldName, 'with value:', agentName);
                    fieldsUpdated++;
                } else {
                    console.log('As Earned HTML Widget: Field not found:', fieldName);
                }
            });
            
            console.log('As Earned HTML Widget: Updated', fieldsUpdated, 'fields');
            
            // Also try to update the agent code field if it exists
            const agentCodeFields = [
                'as_earned_AgentCode',
                'agent_code',
                'q10_agent_code'
            ];
            
            agentCodeFields.forEach(fieldName => {
                let field = document.querySelector(`input[name="${fieldName}"]`) || 
                           document.getElementById(fieldName) ||
                           document.querySelector(`input[name*="${fieldName}"]`);
                
                if (field) {
                    field.value = agentCode;
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('As Earned HTML Widget: Updated agent code field:', fieldName);
                }
            });
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const button = document.getElementById('lookupButton');
            
            if (show) {
                loading.classList.add('show');
                button.disabled = true;
                button.textContent = 'Looking up...';
            } else {
                loading.classList.remove('show');
                button.disabled = false;
                button.textContent = 'Look Up Agent';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        
        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }
        
        function hideAgentInfo() {
            document.getElementById('agentInfo').classList.remove('show');
        }
        
        function tryAlternativeLookup(agentCode) {
            console.log('As Earned HTML Widget: Trying alternative lookup for:', agentCode);
            
            // For now, let's use a test mode with mock data
            // This will help us verify the form field population works
            const testData = {
                '12345': 'Aaron Holub',
                '67890': 'Jane Smith',
                '11111': 'John Doe'
            };
            
            if (testData[agentCode]) {
                const agentName = testData[agentCode];
                console.log('As Earned HTML Widget: Test mode - Found agent:', agentName);
                
                // Display agent info in widget
                displayAgentInfo(agentName, agentCode);
                
                // Populate form fields directly
                populateFormFields(agentName, agentCode);
                
                // Update debug info
                updateDebugInfo(agentName, agentCode, true, 'TEST MODE');
                
            } else {
                console.log('As Earned HTML Widget: Test mode - Agent not found');
                showError('Agent not found in test data. Try: 12345, 67890, or 11111');
                updateDebugInfo('', agentCode, false, 'TEST MODE');
            }
        }
        
        function updateDebugInfo(agentName, agentCode, success, mode = 'LIVE') {
            const debugDiv = document.getElementById('debugInfo');
            const status = success ? 'Agent found and fields updated' : 'Lookup failed';
            
            debugDiv.innerHTML = `
                <strong>HTML Widget - Direct Form Access (${mode})</strong><br>
                This widget runs in the form context and can directly access form fields.<br>
                <br>
                <strong>Last Lookup:</strong><br>
                • Agent Code: ${agentCode}<br>
                • Agent Name: ${agentName || 'Not found'}<br>
                • Status: ${status}<br>
                • Mode: ${mode}<br>
                <br>
                <strong>Target Fields Being Updated:</strong><br>
                • q10_agent_name<br>
                • agent_name_hidden<br>
                • agent_name<br>
                <br>
                <strong>Test Mode:</strong> Try agent codes 12345, 67890, or 11111<br>
                <strong>This should work because the widget runs in the form context!</strong>
            `;
        }
        
        function testMode() {
            console.log('As Earned HTML Widget: Test mode activated');
            const agentCode = '12345';
            const agentName = 'Aaron Holub';
            
            // Set the input field
            document.getElementById('agentCodeInput').value = agentCode;
            
            // Display agent info in widget
            displayAgentInfo(agentName, agentCode);
            
            // Populate form fields directly
            populateFormFields(agentName, agentCode);
            
            // Update debug info
            updateDebugInfo(agentName, agentCode, true, 'TEST MODE');
        }
        
        // Initialize
        console.log('As Earned HTML Widget: Ready');
    </script>
</body>
</html>
