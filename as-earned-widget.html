<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>As Earned Agent Lookup Widget - Final</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background: transparent;
        }
        
        .widget-container {
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group input[readonly] {
            background-color: #f9fafb;
            color: #6b7280;
        }
        
        .loading {
            display: none;
            color: #667eea;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .error {
            display: none;
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .success {
            display: none;
            color: #10b981;
            font-size: 0.9rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="form-group">
            <label for="as_earned_AgentCode">Agent Code *</label>
            <input type="text" id="as_earned_AgentCode" name="as_earned_AgentCode" placeholder="Enter agent code...">
            <div class="loading" id="loading">Looking up agent...</div>
            <div class="error" id="error">Agent not found</div>
            <div class="success" id="success">Agent found! Check the form fields below.</div>
        </div>
        
        <!-- Display found agent info -->
        <div class="form-group" id="agentInfo" style="display: none;">
            <label>Found Agent:</label>
            <input type="text" id="foundAgentName" readonly placeholder="Agent name will appear here">
        </div>
    </div>

    <!-- Include JotForm Custom Widget API -->
    <script src="https://js.jotform.com/JotFormCustomWidget.js"></script>
    
    <script type="text/javascript">
        // Configuration
        const CONFIG = {
            proxyEndpoint: 'https://default3bbdae4643cd41c5868fb316259734.bd.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c047d855f89d41688ffb7de54a581cee/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=KKmAhgBHOwwp0o6ck-F08gyWpiCia6Xdv-WE2MZLUns'
        };

        class AsEarnedAgentLookupWidgetFinal {
            constructor() {
                this.isProcessing = false;
                this.init();
            }

            init() {
                console.log('As Earned Agent Lookup Widget Final: Initializing...');
                this.setupEventListeners();
            }

            setupEventListeners() {
                const agentCodeField = document.getElementById('as_earned_AgentCode');
                
                if (agentCodeField) {
                    agentCodeField.addEventListener('blur', (e) => {
                        if (!this.isProcessing) {
                            this.lookupAgent(e.target.value);
                        }
                    });
                    
                    agentCodeField.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !this.isProcessing) {
                            e.preventDefault();
                            this.lookupAgent(e.target.value);
                        }
                    });
                }
            }

            async lookupAgent(agentCode) {
                if (!agentCode || agentCode.trim() === '') {
                    this.clearFields();
                    return;
                }

                if (this.isProcessing) {
                    return;
                }

                this.isProcessing = true;
                this.showLoading(true);
                this.showError(false);
                this.showSuccess(false);

                try {
                    const result = await this.makeSecureApiCall(agentCode);
                    
                    if (result && result.success && result.data) {
                        this.handleSuccessfulLookup(result.data);
                    } else {
                        this.handleFailedLookup();
                    }
                } catch (error) {
                    console.error('As Earned Agent Lookup Widget Final: Lookup error:', error);
                    this.handleFailedLookup();
                } finally {
                    this.isProcessing = false;
                    this.showLoading(false);
                }
            }

            async makeSecureApiCall(agentCode) {
                try {
                    const response = await fetch(CONFIG.proxyEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            as_earned_AgentCode: agentCode
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('As Earned Agent Lookup Widget Final: API response:', result);
                    
                    // Wrap the result in the expected format if needed
                    if (result && !result.hasOwnProperty('success')) {
                        console.log('As Earned Agent Lookup Widget Final: Wrapping response in success/data format');
                        const wrappedResult = {
                            success: true,
                            data: result.data || result
                        };
                        console.log('As Earned Agent Lookup Widget Final: Final wrapped result:', wrappedResult);
                        return wrappedResult;
                    }
                    
                    return result;
                } catch (error) {
                    console.error('As Earned Agent Lookup Widget Final: API call failed:', error);
                    throw error;
                }
            }

            handleSuccessfulLookup(agentData) {
                console.log('As Earned Agent Lookup Widget Final: Starting to populate fields with data:', agentData);
                
                // Try multiple possible paths for the agent name
                let agentName = null;
                
                const possiblePaths = [
                    'data.as_earned_AgentName',
                    'as_earned_AgentName',
                    'data.agentName',
                    'agentName',
                    'data.name',
                    'name'
                ];
                
                for (const path of possiblePaths) {
                    agentName = this.getNestedValue(agentData, path);
                    console.log(`As Earned Agent Lookup Widget Final: Trying path '${path}':`, agentName);
                    if (agentName) {
                        console.log(`As Earned Agent Lookup Widget Final: Found agent name at path '${path}':`, agentName);
                        break;
                    }
                }
                
                if (agentName) {
                    console.log('As Earned Agent Lookup Widget Final: Found agent name:', agentName);
                    
                    // Display in widget
                    this.displayAgentInfo(agentName);
                    
                    // Send to JotForm using the Custom Widget API
                    this.sendToJotForm(agentName);
                    
                    this.showSuccess(true);
                    this.showError(false);
                } else {
                    console.log('As Earned Agent Lookup Widget Final: No agent name found');
                    this.handleFailedLookup();
                }
            }

            displayAgentInfo(agentName) {
                const agentInfoDiv = document.getElementById('agentInfo');
                const foundAgentNameField = document.getElementById('foundAgentName');
                
                if (agentInfoDiv && foundAgentNameField) {
                    foundAgentNameField.value = agentName;
                    agentInfoDiv.style.display = 'block';
                }
            }

            sendToJotForm(agentName) {
                console.log('As Earned Agent Lookup Widget Final: Sending data to JotForm:', agentName);
                
                if (window.JFCustomWidget) {
                    // Try multiple possible field names that JotForm might use
                    const possibleFieldNames = [
                        'agent_name',
                        'agentname', 
                        'as_earned_agentname',
                        'as_earned_agent_name',
                        'name',
                        'fullname',
                        'agentName',
                        'AgentName'
                    ];
                    
                    // Send to all possible field names
                    const dataToSend = {};
                    possibleFieldNames.forEach(fieldName => {
                        dataToSend[fieldName] = agentName;
                    });
                    
                    console.log('As Earned Agent Lookup Widget Final: Sending data:', dataToSend);
                    JFCustomWidget.sendSubmit(dataToSend);
                } else {
                    console.log('As Earned Agent Lookup Widget Final: JotForm Custom Widget API not available');
                }
            }

            handleFailedLookup() {
                this.clearFields();
                this.showError(true);
                this.showSuccess(false);
            }

            getNestedValue(obj, path) {
                return path.split('.').reduce((current, key) => {
                    return current && current[key] !== undefined ? current[key] : null;
                }, obj);
            }

            clearFields() {
                console.log('As Earned Agent Lookup Widget Final: Clearing fields');
                
                // Clear widget display
                const agentInfoDiv = document.getElementById('agentInfo');
                const foundAgentNameField = document.getElementById('foundAgentName');
                
                if (agentInfoDiv) {
                    agentInfoDiv.style.display = 'none';
                }
                if (foundAgentNameField) {
                    foundAgentNameField.value = '';
                }
                
                // Send empty data to JotForm
                if (window.JFCustomWidget) {
                    const possibleFieldNames = [
                        'agent_name',
                        'agentname', 
                        'as_earned_agentname',
                        'as_earned_agent_name',
                        'name',
                        'fullname',
                        'agentName',
                        'AgentName'
                    ];
                    
                    const dataToSend = {};
                    possibleFieldNames.forEach(fieldName => {
                        dataToSend[fieldName] = '';
                    });
                    
                    JFCustomWidget.sendSubmit(dataToSend);
                }
            }

            showLoading(show) {
                const loadingDiv = document.getElementById('loading');
                if (loadingDiv) {
                    loadingDiv.style.display = show ? 'block' : 'none';
                }
            }

            showError(show) {
                const errorDiv = document.getElementById('error');
                if (errorDiv) {
                    errorDiv.style.display = show ? 'block' : 'none';
                }
            }

            showSuccess(show) {
                const successDiv = document.getElementById('success');
                if (successDiv) {
                    successDiv.style.display = show ? 'block' : 'none';
                }
            }
        }

        // Initialize the widget when the script loads
        document.addEventListener('DOMContentLoaded', () => {
            new AsEarnedAgentLookupWidgetFinal();
        });

        // Also initialize immediately if DOM is already loaded
        if (document.readyState !== 'loading') {
            new AsEarnedAgentLookupWidgetFinal();
        }

        // JotForm Custom Widget Integration
        console.log('As Earned Agent Lookup Widget Final: Checking for JotForm Custom Widget API...');
        console.log('As Earned Agent Lookup Widget Final: window.JFCustomWidget available:', !!window.JFCustomWidget);
        
        if (window.JFCustomWidget) {
            console.log('As Earned Agent Lookup Widget Final: JotForm Custom Widget API found, setting up listeners');
            JFCustomWidget.subscribe('ready', function() {
                console.log('JotForm Custom Widget: Ready');
            });
            
            JFCustomWidget.subscribe('submit', function() {
                console.log('JotForm Custom Widget: Submit triggered');
                // Send the current values to JotForm
                const agentCode = document.getElementById('as_earned_AgentCode').value;
                
                JFCustomWidget.sendSubmit({
                    'as_earned_AgentCode': agentCode
                });
            });
        } else {
            console.log('As Earned Agent Lookup Widget Final: JotForm Custom Widget API not available - this is normal when testing outside JotForm');
        }
    </script>
</body>
</html>
