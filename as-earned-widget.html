<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>As Earned Agent Lookup Widget - Correct Implementation</title>
    <style>
        .agent-lookup-container {
            max-width: 400px;
            margin: 20px auto;
            padding: 20px;
            border: 2px solid #007cba;
            border-radius: 8px;
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        
        .agent-lookup-container h3 {
            color: #007cba;
            margin-top: 0;
            text-align: center;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .lookup-button {
            width: 100%;
            padding: 12px;
            background-color: #007cba;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .lookup-button:hover {
            background-color: #005a8b;
        }
        
        .lookup-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .agent-info {
            display: none;
            padding: 15px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .agent-info.show {
            display: block;
        }
        
        .agent-name {
            font-size: 18px;
            font-weight: bold;
            color: #155724;
            margin-bottom: 5px;
        }
        
        .agent-code {
            color: #6c757d;
            font-size: 14px;
        }
        
        .error-message {
            display: none;
            padding: 15px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            color: #721c24;
            margin-bottom: 15px;
        }
        
        .error-message.show {
            display: block;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #007cba;
            font-style: italic;
        }
        
        .loading.show {
            display: block;
        }
        
        .debug-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="agent-lookup-container">
        <h3>Agent Lookup Widget</h3>
        
        <div class="input-group">
            <label for="as_earned_AgentCode">Enter Agent Code:</label>
            <input type="text" id="as_earned_AgentCode" placeholder="Enter agent code here">
        </div>
        
        <button class="lookup-button" id="lookupButton" onclick="lookupAgent()">
            Look Up Agent
        </button>
        
        <div class="loading" id="loading">
            Looking up agent...
        </div>
        
        <div class="agent-info" id="agentInfo">
            <div class="agent-name" id="agentName">Agent Name</div>
            <div class="agent-code" id="agentCodeDisplay">Agent Code</div>
        </div>
        
        <div class="error-message" id="errorMessage">
            Agent not found. Please check the agent code and try again.
        </div>
        
        <div class="debug-info" id="debugInfo">
            <strong>Correct Custom Widget Implementation</strong><br>
            This widget uses the proper JFCustomWidget API methods.<br>
            <br>
            <strong>Status:</strong> Ready<br>
            <strong>Widget Value:</strong> <span id="widgetValue">None</span>
        </div>
    </div>

    <script>
        // Correct Custom Widget Implementation
        console.log('As Earned Agent Lookup Widget: Initialized');
        
        // Store the current agent name for submission
        let currentAgentName = '';
        let currentAgentCode = '';
        
        // Subscribe to JotForm events
        if (window.JFCustomWidget) {
            console.log('As Earned Agent Lookup Widget: JotForm Custom Widget API available');
            
            // Subscribe to ready event
            JFCustomWidget.subscribe("ready", function() {
                console.log('As Earned Agent Lookup Widget: Widget ready');
                updateDebugInfo('Widget ready');
            });
            
            // Subscribe to submit event - THIS IS THE KEY!
            JFCustomWidget.subscribe("submit", function() {
                console.log('As Earned Agent Lookup Widget: Form submitting, sending data:', currentAgentName);
                
                const dataToSend = {
                    valid: true,
                    value: currentAgentName || '' // This is what gets included in the submission
                };
                
                console.log('As Earned Agent Lookup Widget: Sending to JotForm:', dataToSend);
                JFCustomWidget.sendSubmit(dataToSend);
            });
            
        } else {
            console.log('As Earned Agent Lookup Widget: JotForm Custom Widget API not available');
        }
        
        function lookupAgent() {
            const agentCode = document.getElementById('as_earned_AgentCode').value.trim();
            
            if (!agentCode) {
                showError('Please enter an agent code');
                return;
            }
            
            console.log('As Earned Agent Lookup Widget: Looking up agent code:', agentCode);
            
            // Show loading state
            showLoading(true);
            hideError();
            hideAgentInfo();
            
            // Use test data for now
            const testData = {
                '12345': 'Aaron Holub',
                '67890': 'Jane Smith',
                '11111': 'John Doe'
            };
            
            // Simulate API call with timeout
            setTimeout(() => {
                if (testData[agentCode]) {
                    const agentName = testData[agentCode];
                    console.log('As Earned Agent Lookup Widget: Found agent:', agentName);
                    
                    // Store the values for submission
                    currentAgentName = agentName;
                    currentAgentCode = agentCode;
                    
                    // Display agent info in widget
                    displayAgentInfo(agentName, agentCode);
                    
                    // Send data immediately to form fields
                    sendDataToForm(agentName, agentCode);
                    
                    // Update debug info
                    updateDebugInfo('Agent found: ' + agentName);
                    
                } else {
                    console.log('As Earned Agent Lookup Widget: Agent not found');
                    currentAgentName = '';
                    currentAgentCode = '';
                    showError('Agent not found. Try: 12345, 67890, or 11111');
                    updateDebugInfo('Agent not found');
                }
                
                showLoading(false);
            }, 1000);
        }
        
        function displayAgentInfo(agentName, agentCode) {
            document.getElementById('agentName').textContent = agentName;
            document.getElementById('agentCodeDisplay').textContent = 'Code: ' + agentCode;
            document.getElementById('agentInfo').classList.add('show');
        }
        
        function sendDataToForm(agentName, agentCode) {
            console.log('As Earned Agent Lookup Widget: Sending data to form fields');
            
            // Try to populate form fields directly
            const fieldNames = [
                'q10_agent_name',
                'agent_name_hidden',
                'agent_name',
                'agentname'
            ];
            
            let fieldsUpdated = 0;
            
            fieldNames.forEach(fieldName => {
                let field = document.querySelector(`input[name="${fieldName}"]`) || 
                           document.getElementById(fieldName);
                
                if (field) {
                    field.value = agentName;
                    console.log('As Earned Agent Lookup Widget: Updated field:', fieldName);
                    fieldsUpdated++;
                }
            });
            
            console.log('As Earned Agent Lookup Widget: Updated', fieldsUpdated, 'form fields');
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const button = document.getElementById('lookupButton');
            
            if (show) {
                loading.classList.add('show');
                button.disabled = true;
                button.textContent = 'Looking up...';
            } else {
                loading.classList.remove('show');
                button.disabled = false;
                button.textContent = 'Look Up Agent';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        
        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }
        
        function hideAgentInfo() {
            document.getElementById('agentInfo').classList.remove('show');
        }
        
        function updateDebugInfo(message) {
            const debugDiv = document.getElementById('debugInfo');
            const widgetValueSpan = document.getElementById('widgetValue');
            
            widgetValueSpan.textContent = currentAgentName || 'None';
            
            debugDiv.innerHTML = `
                <strong>Correct Custom Widget Implementation</strong><br>
                This widget uses the proper JFCustomWidget API methods.<br>
                <br>
                <strong>Status:</strong> ${message}<br>
                <strong>Widget Value:</strong> ${currentAgentName || 'None'}<br>
                <br>
                <strong>How it works:</strong><br>
                • Widget stores agent name in currentAgentName<br>
                • On form submit, sends value via JFCustomWidget.sendSubmit()<br>
                • This value will appear in form submissions<br>
                <br>
                <strong>Test with: 12345, 67890, or 11111</strong>
            `;
        }
        
        // Initialize
        console.log('As Earned Agent Lookup Widget: Ready');
    </script>
</body>
</html>
