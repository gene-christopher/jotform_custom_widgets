<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Agent Lookup Widget</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background: transparent;
        }
        
        .widget-container {
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .form-group input {
            width: 310px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.95rem;
            background-color: #ffffff;
            color: #374151;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .form-group input[readonly] {
            background-color: #ffffff;
            color: #6b7280;
            border-color: #d1d5db;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div class="form-group">
            <label for="agentCodeInput">Enter the Agent Code of the requested As Earned Agent</label>
            <input type="text" id="agentCodeInput" placeholder="Enter agent code...">
        </div>
        
        <div class="form-group">
            <label for="agentNameDisplay">Verify this is the correct Agent Name</label>
            <input type="text" id="agentNameDisplay" readonly placeholder="Agent name will appear here...">
        </div>
    </div>

    <!-- Include JotForm Custom Widget API -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    
    <script type="text/javascript">
        // Configuration
        const CONFIG = {
            proxyEndpoint: 'https://default3bbdae4643cd41c5868fb316259734.bd.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c047d855f89d41688ffb7de54a581cee/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=KKmAhgBHOwwp0o6ck-F08gyWpiCia6Xdv-WE2MZLUns'
        };

        // Global variables
        let isProcessing = false;
        let agentCode = '';
        let agentName = '';

        // Initialize widget
        JFCustomWidget.subscribe("ready", function() {
            setupEventListeners();
            
            JFCustomWidget.subscribe("submit", function() {
                handleFormSubmit();
            });
        });

        function setupEventListeners() {
            const agentCodeInput = document.getElementById('agentCodeInput');
            
            if (agentCodeInput) {
                agentCodeInput.addEventListener('input', function(e) {
                    sendRealTimeUpdate(e.target.value, agentName);
                });
                
                agentCodeInput.addEventListener('blur', function(e) {
                    if (!isProcessing) {
                        lookupAgent(e.target.value);
                    }
                });
                
                agentCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !isProcessing) {
                        e.preventDefault();
                        lookupAgent(e.target.value);
                    }
                });
            }
        }

        function sendRealTimeUpdate(code, name) {
            const data = {
                valid: true,
                value: code,
                agentCode: code,
                agentName: name
            };
            JFCustomWidget.sendData(data);
        }

        function handleFormSubmit() {
            const widgetValue = `Agent Code: ${agentCode} | Agent Name: ${agentName}`;
            const data = {
                valid: true,
                value: widgetValue
            };
            JFCustomWidget.sendSubmit(data);
        }

        async function lookupAgent(code) {
            if (!code || code.trim() === '') {
                clearFields();
                return;
            }

            if (isProcessing) return;

            isProcessing = true;

            try {
                const result = await makeSecureApiCall(code);
                
                if (result && result.success && result.data) {
                    populateFields(result.data, code);
                } else {
                    clearFields();
                }
            } catch (error) {
                clearFields();
            } finally {
                isProcessing = false;
            }
        }

        async function makeSecureApiCall(code) {
            const response = await fetch(CONFIG.proxyEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    as_earned_AgentCode: code
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            if (result && !result.hasOwnProperty('success')) {
                return {
                    success: true,
                    data: result.data || result
                };
            }
            
            return result;
        }

        function populateFields(agentData, code) {
            agentCode = code;
            
            const possiblePaths = [
                'data.as_earned_AgentName',
                'as_earned_AgentName',
                'data.agentName',
                'agentName',
                'data.name',
                'name'
            ];
            
            let name = null;
            for (const path of possiblePaths) {
                name = getNestedValue(agentData, path);
                if (name) break;
            }
            
            if (name) {
                agentName = name;
                const agentNameDisplay = document.getElementById('agentNameDisplay');
                if (agentNameDisplay) {
                    agentNameDisplay.value = name;
                }
                sendRealTimeUpdate(code, name);
            } else {
                clearFields();
            }
        }

        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => {
                return current && current[key] !== undefined ? current[key] : null;
            }, obj);
        }

        function clearFields() {
            agentCode = '';
            agentName = '';
            
            const agentNameDisplay = document.getElementById('agentNameDisplay');
            if (agentNameDisplay) {
                agentNameDisplay.value = '';
            }
            
            sendRealTimeUpdate('', '');
        }
    </script>
</body>
</html>
